### 智能光电循迹小车设计方案

---

#### **一、系统整体方案**
1. **车体结构**  
   - 双电机差速三轮结构（两驱轮+万向轮），通过左右电机差速实现转向，灵活性高。
   - 车体材料：轻质铝合金/3D打印支架，降低惯性。

2. **核心控制**  
   - **主控芯片**：STM32F103C8T6（72MHz Cortex-M3，资源丰富，成本低）。
   - **传感器方案**：5路灰度传感器阵列（TCRT5000红外反射传感器）横向排布，检测黑线位置；备用方案为OV7670摄像头（需优化图像算法）。

3. **赛道适应性**  
   - 直道：匀速行驶，PID调节保持中线。
   - 弯道：差速转向，动态调整PWM占空比。
   - 十字路口：传感器全触发时保持直行2秒，忽略横向路径。

---

#### **二、硬件模块设计**
| **模块**         | **选型及参数**                                                                 | **功能说明**                                                                 |
|------------------|------------------------------------------------------------------------------|-----------------------------------------------------------------------------|
| **电源模块**     | - 输入：2节18650串联（7.4V，容量3000mAh*3组并联）<br>- 输出：LM2596（5V稳压）+ AMS1117（3.3V稳压） | 为STM32、传感器、数码管供电；电机直接由电池驱动。                             |
| **传感器模块**   | 5路TCRT5000红外传感器（间距2cm）                                               | 检测黑线位置，输出模拟信号，通过ADC读取灰度值。                               |
| **电机驱动模块** | TB6612FNG双路H桥驱动芯片（峰值电流3A）                                          | 控制左右电机PWM调速及方向，支持差速转向。                                     |
| **按键与显示**   | - 4x4矩阵按键<br>- 4位共阳数码管（驱动芯片TM1637）                              | 设置速度、转向参数、倒计时；显示电压、运行状态。                              |
| **电压检测**     | 分压电路（电阻比例1:1）+ STM32 ADC                                            | 实时监测电池电压，防止过放，数码管显示。                                      |

---

#### **三、软件逻辑设计**
1. **主程序流程**  
   - 初始化：ADC、PWM、定时器、按键中断。
   - 按键监听：设置速度（0-100% PWM）、转向灵敏度（PID参数）、倒计时（1-60秒）。
   - 循迹模式：  
     ```c
     while(1) {
       read_sensors();        // 读取5路传感器状态
       calculate_error();     // 计算黑线偏移误差（PID输入）
       adjust_motor_speed(); // PID输出调整左右电机PWM
       check_crossing();      // 检测十字路口（全触发则直行2秒）
     }
     ```

2. **十字路口处理**  
   - 触发条件：所有传感器同时检测到黑线。
   - 执行动作：维持直行2秒，屏蔽转向控制，防止误判。

3. **PID控制算法**  
   - 误差计算：`Error = 左2传感器 - 右2传感器`（加权值）。  
   - 输出公式：`PWM_diff = Kp*Error + Kd*(Error - LastError)`  
   - 参数调节：通过按键动态调整`Kp`和`Kd`，适应不同弯道。

---

#### **四、元件清单与成本**
| **元件**               | **型号/规格**          | **单价（元）** | **数量** | **小计（元）** |
|------------------------|-----------------------|---------------|----------|----------------|
| STM32F103C8T6开发板    | 最小系统板            | 25.00         | 1        | 25.00          |
| TCRT5000传感器         | 红外反射式            | 1.50          | 5        | 7.50           |
| TB6612FNG电机驱动      | 双路H桥               | 15.00         | 1        | 15.00          |
| 18650电池              | 3000mAh               | 12.00         | 6        | 72.00          |
| 数码管模块             | 4位共阳（TM1637驱动） | 8.00          | 1        | 8.00           |
| 直流减速电机           | N20（6V 200RPM）      | 20.00         | 2        | 40.00          |
| 万向轮                 | 通用塑料轮            | 5.00          | 1        | 5.00           |
| 其他（电阻、PCB等）    | -                     | 20.00         | 1        | 20.00          |
| **总计**               |                       |               |          | **192.50**     |

---

#### **五、关键问题解决**
1. **抗光照干扰**：TCRT5000加遮光罩，软件动态阈值校准。
2. **高速稳定性**：限制最大PWM占空比（70%），弯道降速。
3. **低电压保护**：电压低于6.5V时蜂鸣器报警，强制停车。

---

#### **六、扩展优化**
- 升级为摄像头方案（OV7670+二值化处理），提升复杂路径识别能力。
- 增加蓝牙/WiFi模块，实现手机远程控制及参数调试。

--- 

该方案成本可控（约200元），满足赛道全路径循迹及用户交互需求，适合快速原型开发。